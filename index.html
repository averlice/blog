<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Adison Verlice — Blog index</title>
<style>
  :root{color-scheme:light dark}
  body{font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; max-width:860px;margin:36px auto;line-height:1.6;padding:0 18px;color:#0b1220}
  h1{font-size:1.25rem;margin:.6rem 0;border-bottom:1px solid #eee;padding-bottom:.25rem}
  .intro{margin-bottom:18px}
  .entry{margin-bottom:26px}
  .meta{color:#586069;font-size:.9rem;margin-top:6px}
  pre.desc{white-space:pre-wrap;background:#fbfcfd;padding:10px;border-radius:6px;border:1px solid #f0f3f6}
  .file-list{margin-top:8px}
  .file-link{display:inline-block;margin-right:.6rem;margin-bottom:.35rem}
  a.summary-link{color:#0366d6;text-decoration:none;font-weight:600}
  footer{margin-top:32px;color:#6b7280;font-size:.9rem}
  .error{color:#b02a37;background:#fff0f0;padding:10px;border-radius:6px;border:1px solid #f4c6c6;margin-top:12px}
  #loading{text-align:center;padding:20px;color:#586069}
  .spinner{display:inline-block;width:18px;height:18px;border:3px solid #ddd;border-top-color:#0366d6;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-left:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <h1>adison verlice blog</h1>
  <p class="intro">welcome to adison verlices blog. here, i will post anything and everything, from...well, anything i want. lol.</p>

  <h1>file index</h1>
  <div id="loading">Loading blog index...<span class="spinner"></span></div>
  <div id="output"></div>
  <footer id="footer"></footer>

<script>
const REPO_OWNER = 'averlice';
const REPO_NAME = 'blog';
const BASE_URL = 'https://blindsoft.net/blog/';

const $ = id => document.getElementById(id);

function escapeHtml(s='') {
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

async function ghFetch(url) {
  const headers = {
    'Accept': 'application/vnd.github+json',
    'User-Agent': 'static-index-page'
  };
  const res = await fetch(url, { headers });
  if (!res.ok) {
    const text = await res.text().catch(()=>res.statusText);
    throw new Error(`${res.status} ${res.statusText} — ${text}`);
  }
  return res.json();
}

function splitCommitMessage(fullMsg) {
  if (!fullMsg) return {summary:'(no message)', description:''};
  const lines = fullMsg.split(/\r?\n/);
  const summary = (lines.shift()||'').trim() || '(no summary)';
  if (lines.length && lines[0].trim()==='') lines.shift();
  const description = lines.join('\n').trim();
  return {summary, description};
}

function basename(path) {
  return path.split('/').pop();
}

async function generate() {
  try {
    const repoInfo = await ghFetch(`https://api.github.com/repos/${encodeURIComponent(REPO_OWNER)}/${encodeURIComponent(REPO_NAME)}`);
    const branch = repoInfo.default_branch || 'main';

    const treeResp = await ghFetch(`https://api.github.com/repos/${encodeURIComponent(REPO_OWNER)}/${encodeURIComponent(REPO_NAME)}/git/trees/${encodeURIComponent(branch)}?recursive=1`);
    const tree = treeResp.tree || [];

    const files = tree.filter(e => e.type === 'blob' && (e.path.endsWith('.html') || e.path.endsWith('.htm')));
    if (files.length === 0) {
      $('output').innerHTML = '<div class="error">No HTML files found in the repository.</div>';
      $('loading').style.display = 'none';
      return;
    }

    // Process files with some delay between API calls to avoid rate limits
    const results = [];
    for (const file of files) {
      try {
        const commits = await ghFetch(`https://api.github.com/repos/${encodeURIComponent(REPO_OWNER)}/${encodeURIComponent(REPO_NAME)}/commits?path=${encodeURIComponent(file.path)}&per_page=1`);
        if (Array.isArray(commits) && commits.length > 0) {
          results.push({ path: file.path, basename: basename(file.path), commit: commits[0] });
        }
        // Small delay between API calls
        await new Promise(resolve => setTimeout(resolve, 100));
      } catch (err) {
        console.warn('Error fetching commits for', file.path, err);
      }
    }

    // Group by commit sha
    const commitMap = new Map();
    for (const r of results) {
      if (!r.commit) continue;
      const sha = r.commit.sha;
      if (!commitMap.has(sha)) {
        const fullMsg = r.commit.commit && r.commit.commit.message ? r.commit.commit.message : '';
        const {summary, description} = splitCommitMessage(fullMsg);
        const date = (r.commit.commit && (r.commit.commit.author?.date || r.commit.commit.committer?.date)) || '';
        commitMap.set(sha, { sha, summary, description, date, files: [] });
      }
      commitMap.get(sha).files.push({ path: r.path, basename: r.basename });
    }

    const commitsArr = Array.from(commitMap.values()).sort((a,b) => {
      if (!a.date && !b.date) return 0;
      if (!a.date) return 1;
      if (!b.date) return -1;
      return new Date(b.date) - new Date(a.date);
    });

    const out = [];
    if (commitsArr.length === 0) {
      out.push('<div class="error">No blog entries found.</div>');
    } else {
      for (const c of commitsArr) {
        out.push(`<article class="entry">`);
        out.push(`<h1>${escapeHtml(c.summary)}</h1>`);
        if (c.description) {
          out.push(`<pre class="desc">${escapeHtml(c.description)}</pre>`);
        }
        out.push(`<div class="file-list">`);
        for (const f of c.files) {
          const url = BASE_URL + encodeURIComponent(f.basename);
          out.push(`<div class="file-link"><a class="summary-link" href="${url}">${escapeHtml(c.summary)}</a></div>`);
        }
        out.push(`</div>`);
        out.push(`<div class="meta">updated: ${new Date(c.date).toLocaleDateString()}</div>`);
        out.push(`</article>`);
      }
    }

    $('output').innerHTML = out.join('\n');
    $('loading').style.display = 'none';
    $('footer').textContent = `Last updated ${new Date().toLocaleDateString()}.`;

  } catch (err) {
    $('output').innerHTML = `<div class="error">Sorry, couldn't load the blog index right now. Please try again in a few minutes.</div>`;
    $('loading').style.display = 'none';
    console.error('Error generating index:', err);
  }
}

// Start generating as soon as the page loads
generate();
</script>
</body>
</html>